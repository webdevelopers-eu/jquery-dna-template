/*! Javascript Lazy Template | MIT License | (c) Daniel Ševčík | www.webdevelopers.eu */
$.fn.template=function(a,b){function c(a,b){function c(a,b,c){var d;return d="string"==typeof a&&a.match("(\\$\\{|%24%7B)"+b+"(\\}|%7D)")?a.replace(new RegExp("\\$\\{"+b+"\\}","g"),c).replace(new RegExp("%24%7B"+b+"%7D","g"),c):c,d}function d(a,b,c,d){if(d[c])return b;d[c]=!0;var e=a.data("template:"+c);return"string"==typeof e?e:(a.data("template:"+c,b),b)}if("object"!=typeof a)throw console.log("replaceVars: Cannot replace variables inside the context",a,b),new Error("Cannot replace HTML variables.");var e=b.find("*[template^=\"[\"] *[template^=\"[\"], *[template^=\"{\"] *[template^=\"[\"], *[template^=\"[\"] *[template^=\"{\"], *[template^=\"{\"] *[template^=\"{\"]"),f=b.find("*[template^=\"[\"], *[template^=\"{\"]").not(e),g=$.map(a,function(a,b){return"*[z-var*=\""+b+" \"]"}).join(", ");return b.find(g).not(f.find(g).add(f)).add(b.filter(g)).not(b.find("*[template-scope] *[z-var]")).each(function(b,e){var f={},g=null,h={};$.each(a,function(b,j){for(var k,l=$(e),m=$.trim(l.attr("z-var")).split(","),n=0;n<m.length;n++){if(k=$.trim(m[n]).split(/\s+/),"debugger"==k[0]){debugger;continue}if(k[0]==b||k[0]=="!"+b){var o=k[1]||".",p=!("object"==typeof j&&$.isEmptyObject(j))&&(!$.isNumeric(j)||parseFloat(j))&&j;p="!"==k[0].substr(0,1)?!p:p;var q=$.type(j).match(/string|number/)?j:"";if($.isArray(j)&&(q=j.length),"?"==o)g=(null===g||g)&&p;else if("!"==o)p||l.remove();else if("."==o)l.text(c(d(l,l.text(),o,f),b,q));else if("+"==o)l.get(0).innerHTML=$("<div></div>").html(j).html();else if("="==o)l.is(":checkbox, :radio")?l.prop("checked",$.type(j).match(/string|number/)?l.val()==q:p):l.val(j);else if(":"==o.substr(0,1))p&&l.trigger(o.substr(1),[a,b]);else if("."==o.substr(0,1)){var r=o.substr(1).replace("."," ");p?(h[o]=!0,l.addClass(r)):!h[o]&&(h[o]=!0,l.removeClass(r))}else"@"==o.substr(0,1)?"boolean"==$.type(j)?l.attr(o.substr(1),p?o.substr(1):null):l.attr(o.substr(1),c(d(l,l.attr(o.substr(1)),o,f),b,q)):console.log("Error: replaceVars(): invalid target \""+o+"\" for variable \""+b+"\" in \""+l.attr("z-var")+"\"")}}}),null!==g&&($(e).toggleClass("dna-template-visible",g).toggleClass("dna-template-hidden",!g),g&&"none"==e.style.display&&$(e).css("display",""))}),f.each(function(){var b=$(this),c=b.attr("template").match(/^([{\[])(.*)[\]}]$/),d="{"==c[1],e=c[2],f=a[e];if("undefined"!=typeof f&&null!==f)if(b.siblings("[template-clone]").filter(function(){return $(this).attr("template-clone")==b.attr("template")}).remove(),d)"object"!=$.type(f)&&(f={value:f}),b.template(f,!1);else switch($.isEmptyObject(f)&&(f=[]),$.type(f)){case"string":case"number":case"bool":case"object":f=[f];case"array":$.each(f,function(a,c){b.template($.isPlainObject(c)?c:{value:c})});}}),b}var d=$();if($(this).add(d).trigger("template:before",[a,this,d,b]),$.isArray(a))for(var e=0;e<a.length;e++)d.add($(this).template(a[e],b));else this.each(function(){var e=$(this),f="boolean"==typeof b?b:!e.is("[template]"),g=f?e:e.clone().addClass("template-clone").attr("template-clone",e.attr("template")).insertBefore(this),h=c(a,g).removeAttr("template");d=d.add(h)});return $(this).add(d).trigger("template:after",[a,this,d,b]),d};
