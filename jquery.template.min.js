/*! Javascript Lazy Template 1.0 | MIT License | (c) Daniel Ševčík | www.webdevelopers.eu */
$.fn.template=function(a,b){function c(a,b){function c(a,b,c){var d;return d="string"==typeof a&&a.match("(\\$\\{|%24%7B)"+b+"(\\}|%7D)")?a.replace(new RegExp("\\$\\{"+b+"\\}","g"),c).replace(new RegExp("%24%7B"+b+"%7D","g"),c):c,d}function d(a,b,c,d){if(d[c])return b;d[c]=!0;var e=a.data("template:"+c);return"string"==typeof e?e:(a.data("template:"+c,b),b)}if("object"!=typeof a)throw console.log("replaceVars: Cannot replace variables inside the context",a,b),new Error("Cannot replace HTML variables.");var e=b.find("*[template^=\"[\"] *[template^=\"[\"], *[template^=\"{\"] *[template^=\"[\"], *[template^=\"[\"] *[template^=\"{\"], *[template^=\"{\"] *[template^=\"{\"]"),f=b.find("*[template^=\"[\"], *[template^=\"{\"]").not(e),g=$.map(a,function(a,b){return"*[z-var*=\""+b+" \"]"}).join(", ");return b.find(g).not(f.find(g).add(f)).add(b.filter(g)).not(b.find("*[template-scope] *[z-var]")).each(function(b,e){var f={},g=null,h={};$.each(a,function(a,b){for(var j,k=$(e),l=$.trim(k.attr("z-var")).split(","),m=0;m<l.length;m++){if(j=$.trim(l[m]).split(/\s+/),"debugger"==j[0]){debugger;continue}if(j[0]==a||j[0]=="!"+a){var n=j[1]||".",o=!("object"==typeof b&&$.isEmptyObject(b))&&(!$.isNumeric(b)||parseFloat(b))&&b;o="!"==j[0].substr(0,1)?!o:o;var p=$.type(b).match(/string|number/)?b:"";if($.isArray(b)&&(p=b.length),"?"==n)g=(null===g||g)&&o;else if("!"==n)o||k.remove();else if("."==n)k.text(c(d(k,k.text(),n,f),a,p));else if("+"==n)k.get(0).innerHTML=$("<div></div>").html(b).html();else if("="==n)k.is(":checkbox, :radio")?k.prop("checked",$.type(b).match(/string|number/)?k.val()==p:o):k.val(b);else if(":"==n.substr(0,1))k.trigger(n.substr(1),[]);else if("."==n.substr(0,1)){var q=n.substr(1).replace("."," ");o?(h[n]=!0,k.addClass(q)):!h[n]&&(h[n]=!0,k.removeClass(q))}else"@"==n.substr(0,1)?"boolean"==$.type(b)?k.attr(n.substr(1),o?n.substr(1):null):k.attr(n.substr(1),c(d(k,k.attr(n.substr(1)),n,f),a,p)):console.log("Error: replaceVars(): invalid target \""+n+"\" for variable \""+a+"\" in \""+k.attr("z-var")+"\"")}}}),null!==g&&($(e).toggleClass("dna-template-visible",g).toggleClass("dna-template-hidden",!g),g&&"none"==e.style.display&&$(e).css("display",""))}),f.each(function(){var b=$(this),c=b.attr("template").match(/^([{\[])(.*)[\]}]$/),d="{"==c[1],e=c[2],f=a[e];if("undefined"!=typeof f&&null!==f)if(b.siblings("[template-clone]").filter(function(){return $(this).attr("template-clone")==b.attr("template")}).remove(),d)"object"!=$.type(f)&&(f={value:f}),b.template(f,!1);else switch($.isEmptyObject(f)&&(f=[]),$.type(f)){case"string":case"number":case"bool":case"object":f=[f];case"array":$.each(f,function(a,c){b.template($.isPlainObject(c)?c:{value:c})});}}),b}var d=$();if($(this).add(d).trigger("template:before",[a,this,d,b]),$.isArray(a))for(var e=0;e<a.length;e++)d.add($(this).template(a[e],b));else this.each(function(){var e=$(this),f="boolean"==typeof b?b:!e.is("[template]"),g=f?e:e.clone().addClass("template-clone").attr("template-clone",e.attr("template")).insertBefore(this),h=c(a,g).removeAttr("template");d=d.add(h)});return $(this).add(d).trigger("template:after",[a,this,d,b]),d};
